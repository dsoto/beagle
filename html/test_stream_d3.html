<html>
<head>
    <link type="text/css" rel="stylesheet" href="line.css"/>
    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.time.js"></script>
    <script src=http://code.jquery.com/jquery.js></script>
</head>
<body>
    <script type="text/javascript">
        url =  "http://app.nimbits.com/service/series?"
               + "email=drdrsoto@gmail.com"
               + "&secret=01787ade-c6d6-4f9b-8b86-20850af010d9"
               + "&point=603_Test_Stream"
               + "&count=150";

        jQuery.getJSON(
            url,
            {format:"json"},
            // json object/string gets placed in data
            // values field of object is an array of strings with individual values
            // we lump these into an object named d3values
            function(data) {
                var times = new Array();
                var ydata = new Array();
                for (i in data) {
                    data[i].d = data[i].d/4096.0*1.8*100;
                    // date object
                    times[i] = new Date(data[i].timestamp);
                    ydata[i] = data[i].d;
                 }
                 var w = 500,
                     h = 500,
                     p = 50,
                     x = d3.time.scale()
                                .domain([d3.min(times),d3.max(times)])
                                .range([0,w]),
                     y = d3.scale.linear()
                                 .domain([d3.min(ydata),d3.max(ydata)])
                                 .range([h,0]);

                 // create axes
                 var vis = d3.select("body")
                             .data([data])
                             .append("svg:svg")
                             .attr("width", w + p * 2)
                             .attr("height", h + p * 2)
                             .append("svg:g")
                             .attr("transform", "translate(" + p + "," + p + ")");

                 // line path
                 vis.append("svg:path")
                    .attr("class","line")
                    .attr("d", d3.svg.line()
                     // d is some magic that iterates over the d3values object
                    .x( function(d) { return x(d.timestamp);} )
                    .y( function(d) { return y(d.d);} ));

                // data points as circles
                vis.selectAll("circle.line")
                    .data(data)
                    .enter().append("svg:circle")
                    .attr("class","line")
                    .attr("cx", function(d) { return x(d.timestamp);})
                    .attr("cy", function(d) { return y(d.d);})
                    .attr("r", 2);

                 var vrules = vis.selectAll("g.vrule")
                     .data(x.ticks(d3.time.hours, 2))
                     .enter().append("svg:g")
                     .attr("class", "rule");

                 // vertical grid lines
                 vrules.append("svg:line")
                     //.attr("class", function (d,i) {return i ? null : "axis";})
                     .attr("x1", x)
                     .attr("x2", x)
                     .attr("y1", 0)
                     .attr("y2", h - 1);

                 // x tick text
                 vrules.append("svg:text")
                     .attr("x", x)
                     .attr("y", h + 20)
                     .attr("dy", ".71em")
                     .attr("text-anchor", "middle")
                     //.text(x.tickFormat(d3.time.hours, 2));
                     .text(d3.time.format('%m-%d %H:%M'));

                // vertical axis line
                // right now this is redundant since a line gets inked for each data element
                vrules.append("svg:line")
                    // axis has different stroke in css
                    .attr("class", "axis")
                    .attr("x1", x(d3.min(times)))
                    .attr("x2", x(d3.min(times)))
                    .attr("y1", y(d3.min(ydata)))
                    .attr("y2", y(d3.max(ydata)));

                var hrules = vis.selectAll("g.hrule")
                    .data(y.ticks(10))
                    .enter().append("svg:g")
                    .attr("class", "rule");

                // y tick text
                 hrules.append("svg:text")
                     .attr("y", y)
                     .attr("x", -10)
                     .attr("dy", ".35em")
                     .attr("text-anchor", "end")
                     .text(y.tickFormat(10));
                     //.text(String);

                // horizontal grid lines
                 hrules.append("svg:line")
                     .attr("x1", x(d3.min(times)))
                     .attr("x2", x(d3.max(times)))
                     .attr("y1", y)
                     .attr("y2", y);

                // horizontal axis line
                hrules.append("svg:line")
                    .attr("class", "axis")
                    .attr("x1", x(d3.min(times)))
                    .attr("x2", x(d3.max(times)))
                    .attr("y1", y(d3.min(ydata)))
                    .attr("y2", y(d3.min(ydata)));

            });

    </script>
</body>
</html>

